@page "/users/{userId}"
@attribute [Authorize]

@using OroIdentity.Web.Client.Interfaces
@using OroIdentity.Web.Client.Models

@inject NavigationManager NavigationManager
@inject IIdentificationTypeService IdentificationTypeService
@inject IUsersService Service

<PageTitle>Edit User</PageTitle>

<HeaderPagesComponent TitlePage="Users" Description="Edit user">
    <FluentButton Appearance="Appearance.Accent" OnClick="RedirectToUsers">Back</FluentButton>
</HeaderPagesComponent>

<FluentDivider Style="width: 100%;height:20px;" Orientation=Orientation.Horizontal Role="DividerRole.Separator"></FluentDivider>

@if (user != null)
{
    <FluentCard>
        <FluentStack Orientation="Orientation.Vertical" Gap="1rem">
            <FluentTextField Label="Name" @bind-Value="user.Name" />
            <FluentTextField Label="Middle Name" @bind-Value="user.MiddleName" />
            <FluentTextField Label="Last Name" @bind-Value="user.LastName" />
            <FluentTextField Label="User Name" @bind-Value="user.UserName" />
            <FluentTextField Label="Email" @bind-Value="user.Email" />
            <FluentTextField Label="Identification" @bind-Value="user.Identification" />
            <FluentSelect 
            Label="Identification Type Id" 
            @bind-Value="identificationTypeIdString" 
            OptionValue="@(t => t.Id.Value.ToString())"
            OptionText="@(t => t.Name.Value)"
            Items="IdentificationTypes" />
            <FluentButton Appearance="Appearance.Accent" OnClick="UpdateUser">Update</FluentButton>
        </FluentStack>
    </FluentCard>
}

@code {
    [Parameter]
    public string userId { get; set; }
    public List<IdentificationTypeViewModel> IdentificationTypes { get; set; } = new List<IdentificationTypeViewModel>();

    private UserViewModel? user;
    private string identificationTypeIdString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadIdentificationTypes();
        await LoadUser();
    }

    private async Task LoadIdentificationTypes()
    {
        CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(2));
        var result = (await IdentificationTypeService.GetAllIdentificationTypesAsync(cts.Token));
        if(result != null && result.Data != null)
        {
            IdentificationTypes = result.Data.ToList();
        }
    }

    private async Task LoadUser()
    {
        CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(2));
        user = await Service.GetUserByIdAsync(userId, cts.Token);
        if(user != null && user.IdentificationTypeId != null)
        {
            identificationTypeIdString = user.IdentificationTypeId.Value.ToString();
        }
    }


    private async Task UpdateUser()
    {
        if (user != null && Guid.TryParse(identificationTypeIdString, out var id))
        {
            CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(2));
            user.IdentificationTypeId = IdViewModel.New(id);
            await Service.UpdateUserAsync(user, cts.Token);
            NavigationManager.NavigateTo("/users");
        }
    }

    private void RedirectToUsers()
    {
        NavigationManager.NavigateTo("/users");
    }
}