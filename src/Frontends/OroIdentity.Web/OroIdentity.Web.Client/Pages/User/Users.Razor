@page "/users"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using OroIdentity.Web.Client.Components
@using OroIdentity.Web.Client.Interfaces
@using OroIdentity.Web.Client.Models

@inject NavigationManager NavigationManager
@inject IUsersService Service

<PageTitle>Users</PageTitle>

<HeaderPagesComponent TitlePage="Users"
Description="Manage your Users"
>
<FluentButton Appearance="Appearance.Accent" OnClick="RedirectToCreatePage">Create User</FluentButton>
</HeaderPagesComponent>

<FluentDivider Style="width: 100%;height:20px;" Orientation=Orientation.Horizontal Role="DividerRole.Separator">
</FluentDivider>

<FluentDataGrid Items="users" Style="width:100%;">
    <TemplateColumn Title="Action">
        <FluentButton OnClick="(() => RedirectEdit(context.UserName))" Appearance="Appearance.Accent">Edit</FluentButton>
    </TemplateColumn>
    <TemplateColumn Title="Name" SortBy="sortByName">
        @context.Name
    </TemplateColumn>
    <TemplateColumn Title="Last Name">
        @context.LastName
    </TemplateColumn>
    <TemplateColumn Title="Email">
        @context.Email
    </TemplateColumn>
</FluentDataGrid>

@code {
    [PersistentState]
    public IQueryable<UserViewModel> users { get; set; }

    GridSort<UserViewModel> sortByName = GridSort<UserViewModel>
        .ByAscending(p => p.Name);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(2));
        var usersList =
            await Service.GetAllUsersAsync(cts.Token);
        users = usersList.Data.AsQueryable();
    }

    private void RedirectToCreatePage()
    {
        NavigationManager.NavigateTo("/create-user");
    }

    private void RedirectEdit(string userName)
    {
        NavigationManager.NavigateTo($"/users/{userName}");
    }
}