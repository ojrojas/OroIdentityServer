@page "/create-user"
@attribute [Authorize]

@using OroIdentity.Web.Client.Interfaces
@using OroIdentity.Web.Client.Models

@inject NavigationManager NavigationManager
@inject IUsersService Service
@inject IIdentificationTypeService IdentificationTypeService


<PageTitle>Create User</PageTitle>

<HeaderPagesComponent TitlePage="Users" Description="Create a new user">
    <FluentButton Appearance="Appearance.Accent" OnClick="RedirectToUsers">Back</FluentButton>
</HeaderPagesComponent>

<FluentDivider Style="width: 100%;height:20px;" Orientation=Orientation.Horizontal Role="DividerRole.Separator">
</FluentDivider>

<FluentCard>
    <FluentStack Orientation="Orientation.Vertical" Gap="1rem">
        <FluentTextField Label="Name" @bind-Value="user.Name" />
        <FluentTextField Label="Middle Name" @bind-Value="user.MiddleName" />
        <FluentTextField Label="Last Name" @bind-Value="user.LastName" />
        <FluentTextField Label="User Name" @bind-Value="user.UserName" />
        <FluentTextField Label="Email" @bind-Value="user.Email" />
        <FluentTextField Label="Identification" @bind-Value="user.Identification" />
        <FluentSelect Label="Identification Type Id" @bind-Value="identificationTypeIdString"
                      OptionValue="@(t => t.Id.Value.ToString())"            
                      OptionText="@(t => t.Name.Value)"            
                      Items="IdentificationTypes" />
        <FluentTextField Label="Password" @bind-Value="user.Security.PasswordHash" Type="password" />
        <FluentButton Appearance="Appearance.Accent" OnClick="CreateUserAsync">Create</FluentButton>
    </FluentStack>
</FluentCard>

@code {
    private UserViewModel user = new();
    private string identificationTypeIdString = "";
    public List<IdentificationTypeViewModel> IdentificationTypes { get; set; } = new List<IdentificationTypeViewModel>();
   
    private async Task CreateUserAsync()
    {
        if (Guid.TryParse(identificationTypeIdString, out var id))
        {
            user.IdentificationTypeId = IdViewModel.New(id);
        }

        CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(2));
        await Service.CreateUserAsync(user, cts.Token);
        NavigationManager.NavigateTo("/users");
    }

    private async Task LoadIdentificationTypes()
    {
        CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(2));
        var result = (await IdentificationTypeService.GetAllIdentificationTypesAsync(cts.Token));
        if (result != null && result.Data != null)
        {
            IdentificationTypes = result.Data.ToList();
        }
    }

    private void RedirectToUsers()
    {
        NavigationManager.NavigateTo("/users");
    }
}