@page "/applications/{ClientId}"
@attribute [Authorize]

@using OpenIddict.Abstractions
@using OroIdentity.Web.Client.Constants
@using OroIdentity.Web.Client.Interfaces
@using OroIdentity.Web.Client.Models

@inject IApplicationsService Service
@inject IToastService ToastService
@inject NavigationManager NavigationManager
@inject ILogger<EditApplication> logger


<PageTitle>Edit Application</PageTitle>
<HeaderPagesComponent TitlePage="Edit Applications" Description="@($"Edit your application {ClientId}")">
</HeaderPagesComponent>

<FluentDivider Style="width: 100%;height:20px;" Orientation=Orientation.Horizontal Role="DividerRole.Separator">
</FluentDivider>

<FluentCard>
    <FluentLabel Typo="Typography.H4">Edit Application</FluentLabel>
    <FluentEditForm Model="@editApplication" OnValidSubmit="HandleSubmit">
        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="editApplication.ClientId" Label="ClientId" />
            <FluentTextField @bind-Value="editApplication.DisplayName" Label="DisplayName" Required="true" />
            <FluentSelect @bind-Value="editApplication.ClientType" Label="ClientType"
                          Items="OroIdentityWebConstants.DictionaryClientTypes" Id="clienttype-listbox"
                          OptionValue="@(p => p.Key)" OptionText="@(p => p.Value)" OptionTitle="@(p => p.Value)" />

            <FluentSelect @bind-Value="editApplication.ConsentType" Label="ConsentType"
                          Items="OroIdentityWebConstants.DictionaryConsentTypes" Id="consenttype-listbox"
                          OptionValue="@(p => p.Key)" OptionText="@(p => p.Value)" OptionTitle="@(p => p.Value)" />


            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent">Edit Application</FluentButton>
        </FluentStack>
    </FluentEditForm>
</FluentCard>


@code {
    [Parameter]
    public string ClientId { get; set; } = string.Empty;
    public ApplicationViewModel? editApplication { get; set; }

    protected override async Task OnInitializedAsync()
    {
        editApplication ??= new ApplicationViewModel();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await LoadApplicationById(ClientId);
            }
            catch (Exception ex)
            {
                if (logger.IsEnabled(LogLevel.Information))
                    logger.LogInformation($"Error load applications, {ex.Message}");
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadApplicationById(string ClientId)
    {
        CancellationTokenSource token = new CancellationTokenSource(TimeSpan.FromMinutes(1));
        editApplication = await Service.GetApplicationByClientIdAsync(ClientId, token.Token);
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        await Service.UpdateApplicationAsync(editApplication, CancellationToken.None);
        editApplication = new();
        ToastService.ShowSuccess("Application edited successful");
        await Task.Delay(500);
        NavigationManager.NavigateTo("/applications");
    }
}