@page "/applications"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using OroIdentity.Web.Client.Interfaces
@using OroIdentity.Web.Client.Models
@inject IApplicationsService Service
@inject NavigationManager NavigationManager

<PageTitle>Applications</PageTitle>

<HeaderPagesComponent TitlePage="Applications" Description="Manage your applications">
    <FluentButton Appearance="Appearance.Accent" OnClick="RedirectToCreatePage">Create</FluentButton>
</HeaderPagesComponent>

<FluentDivider Style="width: 100%;height:20px;" Orientation=Orientation.Horizontal Role="DividerRole.Separator"></FluentDivider>

<FluentDataGrid 
    Items="_applicationsIQueryable" 
    Pagination="pagination"
    AutoFit="true"
    RowSize="@DataGridRowSize.Medium">
    <TemplateColumn Title="Action">
        <FluentButton OnClick="(() => RedirectEdit(context.ClientId))">Edit</FluentButton>
    </TemplateColumn>
    <PropertyColumn Property="@(p => p.ApplicationType)" Sortable="true" />
    <PropertyColumn Property="@(p => p.DisplayName)" />
</FluentDataGrid>

@code {
    private IQueryable<ApplicationViewModel>? _applicationsIQueryable;
    @* [PersistentState] *@
    public IEnumerable<ApplicationViewModel>? _applications { get; set; }
    private PaginationState pagination = new PaginationState() { ItemsPerPage = 10 };

    protected override async Task OnInitializedAsync()
    {
        await LoadApplications();
    }

    private async Task LoadApplications()
    {
        CancellationTokenSource token = new CancellationTokenSource(TimeSpan.FromMinutes(1));
        IEnumerable<ApplicationViewModel>? result = await Service.GetAllApplicationAsync(token.Token);
        _applicationsIQueryable = result?.AsQueryable();
    }

    private void RedirectEdit(string ClientId)
    {
        NavigationManager.NavigateTo($"/applications/{ClientId}");
    }

    private void RedirectToCreatePage()
    {
        NavigationManager.NavigateTo("/create-application");
    }
}