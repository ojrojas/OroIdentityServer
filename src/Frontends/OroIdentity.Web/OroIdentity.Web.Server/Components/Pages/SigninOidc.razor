@page "/signin-oidc"
@using OpenIddict.Client
@using Microsoft.AspNetCore.Components

@inject NavigationManager Navigation
@inject OpenIddictClientService OpenIddictClient
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<h1>Sign In with OpenID Connect</h1>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "code")]
    public string? Code { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "state")]
    public string? State { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "iss")]
    public string? Iss { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        // Se corrige la invocación a window.close() para ejecutar la función
        await JSRuntime.InvokeVoidAsync("eval", "window.close()");
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Lógica adicional después del primer renderizado, si es necesario

        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(Code))
        {
            try
            {
                // Intentar completar la autenticación interactiva con OpenIddict
                var response = await OpenIddictClient.AuthenticateInteractivelyAsync(
                    new OpenIddictClientModels.InteractiveAuthenticationRequest    
                {
                    CancellationToken = CancellationToken.None,
                    Nonce = State,
                });

                // Aquí manejamos el token: guardarlo en localStorage, notificar ventana padre y enviar al servidor
                var token = response?.TokenResponse?.AccessToken;
                if (!string.IsNullOrWhiteSpace(token))
                {
                    // Guardar en localStorage
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "access_token", token);

                    // Notificar a la ventana padre (si existe) SOLO como indicación de éxito.
                    try
                    {
                        var message = new { type = "oidc:success" };
                        await JSRuntime.InvokeVoidAsync("eval", $"window.opener.postMessage({System.Text.Json.JsonSerializer.Serialize(message)}, '*')");
                    }
                    catch { }

                    // Enviar token al servidor para procesamiento/almacenamiento en sesión
                    try
                    {
                        await Http.PostAsJsonAsync("/api/auth/external", new { accessToken = token });
                    }
                    catch { }
                }
            }
            catch (Exception)
            {
                // No fallar el renderizado por errores del cliente
            }
            finally
            {
                // Cerrar la ventana popup que el proveedor de identidad pudo haber abierto
                await JSRuntime.InvokeVoidAsync("eval", "window.close()");
            }
        }
    }
}
@*
https://localhost:7264/signin-oidc?code=...&state=...&iss=https%3A%2F%2Flocalhost%3A7219%2F
*@